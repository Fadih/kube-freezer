name: Release Helm Chart

on:
  release:
    types: [published]  # Trigger when a GitHub Release is published

jobs:
  helm-release:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: https://${{ github.repository_owner }}.github.io/kube-freezer
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
      
      - name: Determine version from release tag
        id: version
        run: |
          # Get version from release tag name (e.g., v1.0.0 -> 1.0.0)
          TAG_NAME="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG_NAME"
          echo "Chart version: $VERSION"
      
      - name: Update Chart.yaml version and image tags
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Update chart version in Chart.yaml
          sed -i "s/^version:.*/version: $VERSION/" helm/kube-freezer/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"$VERSION\"/" helm/kube-freezer/Chart.yaml
          # Update image tags in values.yaml to match the released version
          sed -i "s|tag: \".*\"|tag: \"$VERSION\"|g" helm/kube-freezer/values.yaml
          echo "‚úÖ Updated Chart.yaml:"
          cat helm/kube-freezer/Chart.yaml
          echo ""
          echo "‚úÖ Updated image tags in values.yaml:"
          grep -E "tag:|repository:" helm/kube-freezer/values.yaml | head -4
      
      - name: Package Helm chart
        run: |
          mkdir -p ./charts
          helm package helm/kube-freezer -d ./charts
          echo "‚úÖ Packaged chart:"
          ls -lh ./charts/
      
      - name: Create Helm repository index
        run: |
          helm repo index ./charts --url https://${{ github.repository_owner }}.github.io/kube-freezer
          echo "‚úÖ Created index.yaml:"
          cat ./charts/index.yaml
      
      - name: Download existing index (if any)
        run: |
          mkdir -p ./charts-existing
          if curl -sL -f https://${{ github.repository_owner }}.github.io/kube-freezer/index.yaml > ./charts-existing/index.yaml 2>/dev/null; then
            # Validate the downloaded file is not empty and is valid YAML
            if [ -s ./charts-existing/index.yaml ]; then
              # Try to validate YAML syntax
              if command -v yq >/dev/null 2>&1 || python3 -c "import yaml; yaml.safe_load(open('./charts-existing/index.yaml'))" 2>/dev/null; then
                echo "‚úÖ Downloaded existing index.yaml"
                cat ./charts-existing/index.yaml
              else
                echo "‚ö†Ô∏è  Existing index.yaml is invalid YAML, will create new one"
                rm -f ./charts-existing/index.yaml
              fi
            else
              echo "‚ö†Ô∏è  Existing index.yaml is empty, will create new one"
              rm -f ./charts-existing/index.yaml
            fi
          else
            echo "‚ÑπÔ∏è  No existing index found (this is normal for first release)"
          fi
      
      - name: Merge with existing index
        run: |
          if [ -f ./charts-existing/index.yaml ] && [ -s ./charts-existing/index.yaml ]; then
            echo "Merging with existing index..."
            # Validate the index before merging
            if helm repo index ./charts --merge ./charts-existing/index.yaml --url https://${{ github.repository_owner }}.github.io/kube-freezer 2>&1; then
              echo "‚úÖ Successfully merged index.yaml:"
              cat ./charts/index.yaml
            else
              echo "‚ö†Ô∏è  Merge failed, creating new index instead"
              helm repo index ./charts --url https://${{ github.repository_owner }}.github.io/kube-freezer
            fi
          else
            echo "Creating new index (no existing index to merge)"
          fi
      
      - name: Create GitHub Release with chart archive
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ./charts/*.tgz
          body: |
            ## Helm Chart Release
            
            ### Installation
            
            ```bash
            helm repo add kube-freezer https://${{ github.repository_owner }}.github.io/kube-freezer
            helm repo update
            helm install kube-freezer kube-freezer/kube-freezer \
              --namespace kube-freezer \
              --create-namespace \
              --set backend.image.tag=${{ steps.version.outputs.version }} \
              --set frontend.image.tag=${{ steps.version.outputs.version }}
            ```
            
            ### Chart Information
            - **Chart Version**: ${{ steps.version.outputs.version }}
            - **App Version**: ${{ steps.version.outputs.version }}
            - **Release Tag**: ${{ github.event.release.tag_name }}
            
            ### Using the installation script
            
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install-freezer.sh | \
              CHART_VERSION=${{ steps.version.outputs.version }} \
              BACKEND_TAG=${{ steps.version.outputs.version }} \
              FRONTEND_TAG=${{ steps.version.outputs.version }} \
              bash -s -- install
            ```
          draft: false
          prerelease: false
          tag_name: ${{ github.event.release.tag_name }}

      - name: Prepare documentation for Pages
        run: |
          # Create a pages directory structure
          mkdir -p ./pages/docs
          
          # Copy Helm charts
          cp -r ./charts ./pages/
          
          # Copy documentation files
          cp -r ./docs ./pages/
          
          # Create an index.html for the documentation site
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.repository }}"
          REPO_URL="https://${REPO_OWNER}.github.io/kube-freezer"
          
          REPO_OWNER="${REPO_OWNER}" REPO_NAME="${REPO_NAME}" REPO_URL="${REPO_URL}" python3 << 'PYTHON_SCRIPT'
          import os
          
          repo_owner = os.environ.get('REPO_OWNER', 'Fadih')
          repo_name = os.environ.get('REPO_NAME', 'Fadih/kube-freezer')
          repo_url = os.environ.get('REPO_URL', f'https://{repo_owner}.github.io/kube-freezer')
          
          html_content = f'''<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>KubeFreezer Documentation</title>
              <style>
                  body {{
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      line-height: 1.6;
                      max-width: 1200px;
                      margin: 0 auto;
                      padding: 20px;
                      background: #f5f5f5;
                  }}
                  .container {{
                      background: white;
                      padding: 40px;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }}
                  h1 {{
                      color: #2c3e50;
                      border-bottom: 3px solid #3498db;
                      padding-bottom: 10px;
                  }}
                  h2 {{
                      color: #34495e;
                      margin-top: 30px;
                  }}
                  .section {{
                      margin: 30px 0;
                  }}
                  .doc-link {{
                      display: block;
                      padding: 12px;
                      margin: 8px 0;
                      background: #ecf0f1;
                      border-left: 4px solid #3498db;
                      text-decoration: none;
                      color: #2c3e50;
                      border-radius: 4px;
                      transition: background 0.3s;
                  }}
                  .doc-link:hover {{
                      background: #d5dbdb;
                  }}
                  .helm-repo {{
                      background: #e8f5e9;
                      padding: 20px;
                      border-radius: 8px;
                      margin: 20px 0;
                  }}
                  code {{
                      background: #f4f4f4;
                      padding: 2px 6px;
                      border-radius: 3px;
                      font-family: 'Courier New', monospace;
                  }}
                  pre {{
                      background: #2c3e50;
                      color: #ecf0f1;
                      padding: 15px;
                      border-radius: 5px;
                      overflow-x: auto;
                  }}
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üöÄ KubeFreezer Documentation</h1>
                  
                  <div class="section">
                      <p>Kubernetes admission controller for deployment freeze management. Block deployments during maintenance windows, holidays, or scheduled freezes with configurable bypass mechanisms for emergency patches.</p>
                  </div>
                  
                  <div class="helm-repo">
                      <h2>üì¶ Helm Chart Repository</h2>
                      <p>Add the Helm repository:</p>
                      <pre>helm repo add kube-freezer {repo_url}
          helm repo update</pre>
                      <p>Install:</p>
                      <pre>helm install kube-freezer kube-freezer/kube-freezer \\
            --namespace kube-freezer \\
            --create-namespace</pre>
                  </div>
                  
                  <div class="section">
                      <h2>üìö Documentation</h2>
                      <a href="docs/API_KEYS.md" class="doc-link">üîë API Keys - How to generate and use API keys</a>
                      <a href="docs/AUTHENTICATION.md" class="doc-link">üîê Authentication - Authentication methods and setup</a>
                      <a href="docs/BACKEND_AUTHENTICATION.md" class="doc-link">üîí Backend Authentication - Backend authentication details</a>
                      <a href="docs/FRONTEND_DEPLOYMENT.md" class="doc-link">üé® Frontend Deployment - Frontend deployment guide</a>
                      <a href="docs/HOW_TO_USE_TEMPLATES.md" class="doc-link">üìã How to Use Templates - Template usage guide</a>
                      <a href="docs/TEMPLATE_APIS.md" class="doc-link">üîå Template APIs - Template API reference</a>
                      <a href="docs/TEMPLATES_VS_SCHEDULES.md" class="doc-link">‚öñÔ∏è Templates vs Schedules - Understanding the difference</a>
                      <a href="docs/TROUBLESHOOTING_TEMPLATES.md" class="doc-link">üîß Troubleshooting Templates - Common issues and solutions</a>
                  </div>
                  
                  <div class="section">
                      <h2>üîó Links</h2>
                      <p>
                          <a href="https://github.com/{repo_name}">GitHub Repository</a> | 
                          <a href="charts/index.yaml">Helm Chart Index</a>
                      </p>
                  </div>
              </div>
          </body>
          </html>'''
          
          with open('./pages/index.html', 'w') as f:
              f.write(html_content)
          PYTHON_SCRIPT
          echo "‚úÖ Documentation prepared for Pages"
          ls -la ./pages/

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true  # Automatically enable Pages if not enabled

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./pages

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Output release summary
        run: |
          echo "‚úÖ Helm chart release completed successfully!"
          echo ""
          echo "Helm Chart Published:"
          echo "  Chart Version: ${{ steps.version.outputs.version }}"
          echo "  Release Tag: ${{ github.event.release.tag_name }}"
          echo "  Repository: https://${{ github.repository_owner }}.github.io/kube-freezer"
          echo ""
          echo "Installation:"
          echo "  helm repo add kube-freezer https://${{ github.repository_owner }}.github.io/kube-freezer"
          echo "  helm repo update"
          echo "  helm install kube-freezer kube-freezer/kube-freezer --namespace kube-freezer --create-namespace"

